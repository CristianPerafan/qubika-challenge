import os

from deepeval import assert_test
from deepeval.metrics import AnswerRelevancyMetric, GEval
from deepeval.test_case import LLMTestCase,LLMTestCaseParams
from dotenv import load_dotenv


load_dotenv()

if not os.environ.get("OPENAI_API_KEY"):
    os.environ["OPENAI_API_KEY"] = os.getenv("OPENAI_API_KEY")

"""
    - Description: This test is to evaluate the Relevancy of the answer generated by the RAG model
    - Context: This test was mead using as main reference the articles 
      "Presidente Gustavo Petro llego a Brasil para participar de la cumbre del G20" published by El Tiempo.
"""
def test_answer_relevancy():
    answer_relevancy_metric = AnswerRelevancyMetric(threshold=0.5)

    actual_output_ = """
        **Resumen:**
        El presidente de Colombia, Gustavo Petro, viajó a Brasil para participar en la cumbre del G20, donde se abordarán temas económicos y políticos de relevancia internacional.
        
        **Detalles clave:**
        1. El G20 es un foro que reúne a las principales economías del mundo para discutir asuntos globales.
        2. En esta cumbre, se tratarán temas como la recuperación económica post-pandemia, cambio climático, comercio internacional y seguridad.
        3. La participación de Petro en este evento busca fortalecer la presencia de Colombia en el ámbito internacional y promover diálogos estratégicos.
        4. Se espera que el presidente Petro sostenga reuniones bilaterales con otros líderes presentes en la cumbre para abordar temas de interés común.
        
        **Fuente:**
        [El Tiempo - Juan Pablo Penagos Ramírez](https://www.eltiempo.com/politica/gobierno/gustavo-petro-viajo-a-brasil-para-participar-en-la-cumbre-del-g20-655055)
    """
    test_case_relevancy = LLMTestCase(
        input="¿Cuál es el propósito principal de la cumbre del G20 a la que asiste el presidente Petro?",
        actual_output=actual_output_,
        retrieval_context=["La cumbre busca discutir acuerdos para fomentar el desarrollo económico y social global."]
    )

    assert_test(test_case_relevancy,[answer_relevancy_metric])


def test_answer_correctness():
    actual_output_ = """
    ### Lista de Noticias Disponibles:
        1. Presidente Gustavo Petro llegó a Brasil para participar de la cumbre del G20 - El Tiempo - Juan Pablo Penagos Ramírez

        ### Presidente Gustavo Petro en la Cumbre del G20

        #### Resumen:
        El Presidente Gustavo Petro llegó a Brasil para participar en la cumbre del G20, donde se abordarán temas de relevancia mundial.

        #### Detalles Clave:
        - Gustavo Petro es el primer presidente de izquierda en la historia de Colombia.
        - La cumbre del G20 es un espacio importante para discutir asuntos globales como economía, comercio, cambio climático y salud.
        - Petro busca fortalecer relaciones internacionales y promover sus políticas progresistas en este encuentro de líderes mundiales.

        #### Fuente:
        [El Tiempo - Presidente Gustavo Petro en el G20](https://www.eltiempo.com/politica/gobierno/gustavo-petro-llego-a-brasil-para-participar-de-la-cumbre-del-g20-654063)
    """

    correctness_test_case = LLMTestCase(
        input="¿Qué discutió el presidente Gustavo Petro en la cumbre del G20?",
        # Replace this with the actual output of your LLM application
        actual_output=actual_output_,
        expected_output="La cumbre busca discutir acuerdos para fomentar el desarrollo económico y social global."
    )

    correctness_metric = GEval(
        name="Correctness",
        criteria="Correctness - determine if the actual output is correct according to the expected output.",
        evaluation_params=[LLMTestCaseParams.ACTUAL_OUTPUT, LLMTestCaseParams.EXPECTED_OUTPUT],
        strict_mode=True
    )

    correctness_metric.measure(correctness_test_case)





